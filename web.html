<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç¿»è­¯å·¥å…·ï¼ˆæ‹¼éŸ³ï¼‹èªéŸ³ï¼‰</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 30px;
      background-color: #f2f2f2;
    }
    .bigbox {
      background: #fff;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: auto;
    }
    textarea {
      width: 100%;
      height: 150px;
      font-size: 30px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      resize: vertical;
    }
    .grid-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }
    select {
      font-size: 25px;
      padding: 5px 10px;
    }
    .trans, .voice {
      font-size: 22px;
      padding: 8px 16px;
      margin-left: 10px;
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .trans:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    .result {
      margin-top: 30px;
      font-size: 35px;
      font-weight: bold;
    }
    .pinyin {
      font-size: 25px;
      color: #666;
      margin-top: 10px;
    }
  </style>

  <!-- JS å­—å…¸èˆ‡è½‰æ›æ¨¡çµ„ -->
  <script src="https://unpkg.com/wanakana"></script>
  <script src="https://unpkg.com/pinyin/lib/web-pinyin.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dist/kuromoji.js"></script>
</head>
<body>
  <div class="bigbox">
    <label for="sourceText">è¼¸å…¥æ–‡å­—ï¼š</label>
    <textarea id="sourceText" placeholder="è«‹è¼¸å…¥è¦ç¿»è­¯çš„å…§å®¹..."></textarea>

    <label for="targetLang" style="margin-top: 15px; display: block;">ç¿»è­¯æˆï¼š</label>
    <div class="grid-container">
      <select id="targetLang">
        <option value="ja">æ—¥æ–‡</option>
        <option value="en">è‹±æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
      </select>
      <button class="trans" onclick="translateText()" disabled>è¼‰å…¥ä¸­...</button>
      <button class="voice" onclick="playTTS()">ğŸ”Š èªéŸ³</button>
    </div>

    <div class="result" id="translatedText"></div>
    <div class="pinyin" id="pinyinText"></div>
  </div>

  <script>
    let tokenizerReady = false;
    let tokenizer = null;

    // è¼‰å…¥ kuromojiï¼ˆæ—¥æœ¬èªåˆ†è©å™¨ï¼‰
    kuromoji.builder({ dicPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/" })
      .build((err, tkz) => {
        if (err) {
          console.error("kuromoji åˆå§‹åŒ–å¤±æ•—", err);
        } else {
          tokenizer = tkz;
          tokenizerReady = true;
          console.log("âœ… kuromoji è¼‰å…¥å®Œæˆ");
          const btn = document.querySelector(".trans");
          btn.disabled = false;
          btn.innerText = "ç¿»è­¯";
        }
      });

    async function translateText() {
      const text = document.getElementById('sourceText').value;
      const target = document.getElementById('targetLang').value;

      if (!text.trim()) {
        alert('è«‹è¼¸å…¥è¦ç¿»è­¯çš„æ–‡å­—');
        return;
      }

      const response = await fetch(
        `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${target}&dt=t&q=${encodeURIComponent(text)}`
      );
      const data = await response.json();

      const translated = data[0].map(item => item[0]).join('');
      document.getElementById('translatedText').innerText = translated;

      // é¡¯ç¤ºæ‹¼éŸ³æˆ–ç¾…é¦¬éŸ³
      if (target === 'zh-TW') {
        const pinyin = window.pinyin(translated, {
          style: window.pinyin.STYLE_TONE2,
          heteronym: false
        }).flat().join(' ');
        document.getElementById('pinyinText').innerText = `æ‹¼éŸ³ï¼š${pinyin}`;
      } else if (target === 'ja') {
        if (!tokenizerReady) {
          document.getElementById('pinyinText').innerText = 'æ—¥æ–‡æ‹¼éŸ³æ¨¡çµ„å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦...';
          return;
        }

        const tokens = tokenizer.tokenize(translated);
        const kana = tokens.map(token => token.reading || token.surface_form).join('');
        const romaji = wanakana.toRomaji(kana);
        document.getElementById('pinyinText').innerText = `ç¾…é¦¬éŸ³ï¼š${romaji}`;
      } else {
        document.getElementById('pinyinText').innerText = '';
      }
    }

    function playTTS() {
      const text = document.getElementById('translatedText').innerText;
      const lang = document.getElementById('targetLang').value;

      if (!text.trim()) {
        alert('æ²’æœ‰æ–‡å­—å¯æ’­æ”¾');
        return;
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang === 'ja' ? 'ja-JP' : (lang === 'zh-TW' ? 'zh-TW' : 'en-US');
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
